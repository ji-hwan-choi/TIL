# Stop-The-World (STW)의 필요성

## 1. STW의 정의

Stop-The-World(STW)는 가비지 컬렉션(GC)을 수행하기 위해, GC 관련 스레드를 제외한 **모든 애플리케이션 스레드의 실행을 일시적으로 중단**시키는 상태를 의미한다.

이 상태 동안 JVM 위에서 동작하는 모든 자바 코드는 실행을 멈추며, GC가 완료된 후에야 애플리케이션 스레드의 실행이 재개된다. STW는 Minor GC와 Full GC를 포함한 모든 종류의 GC에서 발생한다.

---

## 2. 목적 및 필요성

STW가 필요한 이유는 단 하나, **GC가 메모리의 객체 관계를 파악하는 동안 그 관계가 변하는 것을 막기 위함**이다. 즉, '데이터 정합성'을 지키는 것이 유일한 목적이다.

GC의 핵심 작업은 GC Root로부터 시작하여 객체들의 참조 사슬을 따라가며 '살아있는' 객체를 모두 찾아내는 'Mark(표시)' 과정이다.  
만약 이 과정 중에 애플리케이션 스레드가 객체 간의 참조를 바꾸거나 끊어버린다면, GC는 일관성이 깨진, 엉망이 된 지도를 보고 길을 찾는 것과 같아진다.

---

## 3. STW 부재 시 발생하는 문제: 데이터 정합성 파괴

만약 STW 없이 GC의 객체 탐색과 애플리케이션의 참조 변경이 동시에 발생한다면, GC는 살아있는 객체를 쓰레기로 잘못 식별하여 메모리에서 제거하는 치명적인 오류를 일으킬 수 있다.

1. GC가 특정 객체(A)를 '살아있음'으로 식별하고, A가 참조하는 객체들을 탐색할 준비를 한다.
2. 이때 애플리케이션 스레드가 A의 참조를 다른 객체(C)로 변경하고, 이 C로의 참조 경로는 GC가 이미 탐색을 완료한 다른 객체로부터는 도달할 수 없다고 가정한다.
3. GC는 변경된 참조 정보를 인지하지 못한 채 기존 정보를 바탕으로 탐색을 계속 진행한다.
4. 결과적으로, A가 새로 참조하게 된 객체 C는 GC의 탐색 범위에서 누락된다.
5. 탐색이 종료된 후, C는 어디에서도 도달할 수 없는 객체, 즉 쓰레기로 잘못 분류되어 메모리에서 회수된다.

이후 애플리케이션이 A를 통해 C에 접근을 시도하면, 이미 해제된 메모리에 접근하게 되므로 NullPointerException, 메모리 손상(Memory Corruption) 등 심각한 오류를 유발하며 JVM의 비정상적인 종료로 이어질 수 있다.

## 4. 결론

STW는 위와 같은 데이터 정합성 문제를 원천적으로 차단하고, GC가 힙 메모리에 대한 **정확하고 고정된 스냅샷**을 기반으로 작업을 수행할 수 있도록 보장하는 필수적인 메커니즘이다. 따라서 모든 GC는 논리적으로 STW를 포함하며, 현대 GC 기술의 핵심 과제는 이 STW로 인한 애플리케이션의 중단 시간을 최소화하는 것이다.
