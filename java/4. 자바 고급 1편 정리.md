# 멀티스레드와 동시성

## 1. 프로세스와 스레드

### 멀티태스킹과 멀티프로세싱

#### 단일 프로그램 실행

연산을 처리할 수 있는 CPU 코어가 1개만 있다고 가정 했을때, 초창기 컴퓨터는 한 번에 하나의 프로그램만 실행했다.  
예를들어, 음악을 들으며 워드 프로그램을 실행하고 싶지만 음악 프로그램이 끝나야 워드 프로그램 실행이 가능했다.  
이를 해결하기 위해 하나의 CPU 코어로 여러 프로그램을 동시에 실행하는 '멀티태스킹' 기술이 등장했다.

#### 멀티태스킹

현대의 CPU 는 초당 수십억 번 이상의 연산을 수행한다.
만약 CPU가 매우 빠르게 두 프로그램의 코드를 번갈아 수행한다면, 사람이 느낄 때 두 프로그램이 동시에 실행되는 것
처럼 느껴질 것이다. (대략 0.01초(10ms) 단위로 돌아가며 실행한다.)  
A 프로그램 0.01초 수행 -> B 프로그램 0.01초 수행 -> A프로그램 0.01초 수행  
사용자는 두 프로그램이 동시 실행 되는 것 같이 느낀다.  
이렇게 각 프로그램의 **실행 시간을 분할해서 마치 동시에 실행되는 것 처럼 하는 기법을 시분할(Time Sharing, 시간
공유) 기법**이라 한다.

> CPU에 어떤 프로그램이 얼마만큼 실행될지는 운영체제가 결정하는데 이것을 스케줄링(Scheduling)이라
> 한다. 이때 단순히 시간으로만 작업을 분할하지는 않고, CPU를 최대한 활용할 수 있는 다양한 우선순위와 최적화
> 기법을 사용한다.

#### 멀티프로세싱

컴퓨터 시스템에서 둘 이상의 프로세서(CPU 코어)를 사용하여 여러 작업을 동시
에 처리하는 기술을 의미한다. 멀티프로세싱 시스템은 하나의 CPU 코어만을 사용하는 시스템보다 동시에 더 많은 작업
을 처리할 수 있다.

#### 멀티프로세싱 vs. 멀티태스킹

멀티프로세싱은 하드웨어 장비의 관점이고, 멀티태스킹은 운영체제 소프트웨어의 관점이다.

- **멀티프로세싱**
  - **여러 CPU(여러 CPU 코어)를 사용**하여 동시에 여러 작업을 수행하는 것을 의미한다.
  - 하드웨어 기반으로 성능을 향상시킨다.
  - 예: 다중 코어 프로세서를 사용하는 현대 컴퓨터 시스템
- **멀티태스킹**
  - 단일 CPU(단일 CPU 코어)가 여러 작업을 동시에 수행하는 것처럼 보이게 하는 것을 의미한다.
  - 소프트웨어 기반으로 **CPU 시간을 분할하여 각 작업에 할당**한다.
  - 예: 현대 운영 체제에서 여러 애플리케이션이 동시에 실행되는 환경

---

### 프로세스와 스레드

- **프로세스**

  - 실행중인 프로그램
  - 각 프로세스는 독립적인 메모리 공간을 갖고 있으며, 운영체제에서 별도의 작업 단위로 분리해서 관리된다.
  - 하나의 프로세스가 충돌해도 다른 프로세스에는 영향을 미치지 않는다.

- **스레드**

  - 프로세스는 하나 이상의 스레드를 반드시 포함한다.
  - 스레드는 프로세스 내에서 실행되는 작업의 단위이다.
  - 한 프로세스 내에서 여러 스레드가 존재할 수 있으며, 이들은 **프로세스가 제공하는 동일한 메모리 공간을 공유**한다.
  - 스레드는 프로세스보다 단순하므로 생성 및 관리가 단순하고 가볍다.

- **단일 스레드**: 한 프로세스 내에 하나의 스레드만 존재
- **멀티 스레드**: 한 프로세스 내에 여러 스레드가 존재

#### 멀티스레드가 필요한 이유

- 워드 프로그램으로 문서를 편집하면서, 문서가 자동으로 저장되고, 맞춤법 검사도 함께 수행된다.
- 유튜브는 영상을 보는 동안, 댓글도 달 수 있다.

컨텍스트 스위칭은 CPU가 여러 스레드나 프로세스를 번갈아 실행할 때, 이전에 하던 작업의 상태(어디까지 했는지 등)를 저장하고 다음에 할 작업의 상태를 불러오는 과정이에요. 이 과정에서 약간의 시간이 소요되죠.
단일 코어에서 스레드가 너무 많으면 CPU가 스레드를 자주 바꿔가며 실행해야 해요. 이때 작업 상태를 저장하고 불러오는 컨텍스트 스위칭 비용이 커져서, 오히려 전체 성능이 떨어질 수 있답니다.

---

### 컨텍스트 스위칭

CPU 코어가 하나일 때 멀티태스킹은 여러 스레드를 번갈아가며 실행하는 방식으로 동작한다. 운영체제는 스레드를 잠시 멈출 때 현재 실행 상태(레지스터, 변수 값 등)를 메모리에 저장하고, 다른 스레드 실행 후 다시 불러온다.  
이렇게 문맥을 저장하고 복원하는 과정을 **컨텍스트 스위칭**이라 한다. 이 과정은 CPU 입장에서 추가 작업이 필요하기 때문에 성능 오버헤드가 발생한다.

### CPU-Bound 작업

- CPU 계산이 많은 작업 (예: 수학 연산, 영상 인코딩 등)
- CPU가 작업 속도를 결정
- 스레드 수 = CPU 코어 수 + 1 정도가 적절

### I/O-Bound 작업

- DB, 파일, 네트워크 등 외부 I/O가 많은 작업
- CPU는 대부분 대기 (I/O가 끝날 때까지)
- 스레드 수 = CPU 코어 수보다 훨씬 많이 생성 가능
  - CPU를 충분히 활용할 수 있는 수준까지 스레드 늘림
  - 단, 스레드가 너무 많으면 컨텍스트 스위칭 비용 발생 → 적절한 성능 테스트 필요

### 웹 서버 실무에서의 특징

- 대부분 I/O-Bound 작업 (DB 조회, 네트워크 통신 등)
- 요청 1개당 스레드 1개 사용
- CPU를 거의 사용하지 않으므로 코어 수보다 많은 스레드를 둬도 됨
- 무조건 좋은 서버를 쓰는 것보다 스레드 수 조정이 더 효과적

---
